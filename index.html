<!--
* Homework Card Creator for Trello 
* Build date 7-Sep-2015 9:40pm 
* Evan Strat
-->

<!DOCTYPE html>
<html>

<head>
    <title>Homework Trello Card Creator</title>
    <meta name="viewport" content="initial-scale=1, maximum-scale=1">
    <style>
        body {
            font-family: "Helvetica Neue", sans-serif, serif;
            width: auto;
        }
        
        label.item-title {
            font-weight: bold;
        }
        
        input[type="text"] {
            width: 95vw;
        }
        
        input[type="radio"] {
            margin-bottom: 7px;
        }
        
        .hidden {
            display: none;
        }

    </style>
</head>

<body onload="initialize()">
    <em id="loading">Generating form...</em>
    <div id="app" class="hidden">
        <strong>Quickly create a Trello card</strong>
        <br />and use these attributes:
        <br />
        <br />
        <form>
            <div id="card-name-group">
                <label for="card-name" class="item-title">Assignment name:</label>
                <br />
                <input id="card-name" type="text" />
                <br />
                <br />
            </div>

            <div id="description-group">
            </div>

            <div id="due-date-group">
                <label class="item-title">Due date:</label>
                <br />
                <em>The card due date will be this day at the time defined in Settings.</em>

                <div id="due-date-days">
                    <input type="radio" id="due-date-plus0" name="due-date">
                    <label for="due-date-plus0">Today</label>
                    <br />
                    <input type="radio" id="due-date-plus1" name="due-date">
                    <label for="due-date-plus1">Tomorrow</label>
                    <br />
                </div>
            </div>
            <button onclick="alert('This would ordinarily create a card')">Create card</button>
            <!-- generated on-the-fly via javascipt -->
        </form>
    </div>
    <script type="text/javascript">
        var settings = {
            //variable names that look LIKE_THIS are constants and generally only need to be set once
            firstRun: true, //this will display some instructions to get started on the page; set this to false to hide them
            //these settings control how this app communicates with Trello, via the Trello API
            TRELLO_DEVELOPER_KEY: "ENTER_TRELLO_DEVELOPER_KEY_HERE", //find yours at https://trello.com/1/appKey/generate
            TRELLO_TOKEN: "ENTER_GENERATED_TRELLO_TOKEN_HERE",
            TRELLO_APP_NAME: "Trello Homework Card Creator", //You can set this to whatever you want, ideally something you'll recognize in the future
            TRELLO_READWRITE_AUTH_LENGTH: "ENTER_VALUE_HERE", //This determines how long you'll give yourself (via this app) read/write access to your Trello account.  If you are just trying this out, you can do "1day"; if you want this to work for the next month, enter "30days"; if you want this to work forever, enter "never"
            TRELLO_BOARD_ID: "ENTER_TRELLO_BOARD_ID_HERE", //the 8-character string after 'b/' in the URL of the Trello board you want these cards to appear on

            //these settings control which list(s) your cards are added to on the board you specified
            TRELLO_LISTS: ["ENTER_LIST_IDS", "LIST_ID2"], //an array of lists you want to add cards to.  A dropdown menu to select the list you want will appear at the top if more than one is here.  An error message will appear if no list is specified here
            listAddType: "one", //allowed values: "one" - only add the card to the selected list, "all" - add the card to all lists specified in TRELLO_LISTS

            //these settings control how the card is generated; all can be dynamic; the intent is to save you time from having to do repetitive things, like adding due dates (the whole reason this was created), or assigning users, adding labels, adding a description, etc.
            assignMyself: false, //allowed values: true - use TRELLO_USER_ID to assign yourself to the card you create; useful for showing cards in the Trello Android widget
            TRELLO_USER_ID: "ENTER_USERID_HERE", //if assign myself is here, enter your Trello user id here.  You can find it by looking at one of your cards JSON outputs
            dueDateTime: "0900", //the time when cards will be due, on the date you specify.  Use 24 hour time.  9AM = 0900, 9PM=2100
            descriptionType: "attribution", //allowed values (You can program your own, too.): "attribution" - will put an italicized note saying the card was created using Trello Homework Card Creator, with a link back to the GitHub repository.  You can change this if you don't like it.  "datetime" - will add an italicized date and time that the card was created.  "none" - will show nothing and won't prompt for a description in the form  "custom" - will show a small textarea in the form where you can enter your own description, if you are so inclined
            autoAddLabels: false, //allowed values: "true" - add the labels in LabelsToAdd to the card that is created; "false" (default) - don't auto-add labels
            labelsToAdd: [], //enter label names in this array to have them added to your card, if you wish.  Leave blank to add no labels.  Enclose label names in quotes ,(e.g., label named Important would be entered as "Important").

            //developer - don't change these values unless you know what you're doing
            debugMode: false, //log various things that are useful for debugging in the console
            demoMode: false, //simulate various end results of requests.  accepted values: "success" - pretend that the request succeeded; "ANY_ERROR_CODE" - enter an error code used by this app, and the app will pretend the request failed with that error code
        };

        function initialize() {
            if (settings.descriptionType === "custom") {
                document.getElementById('description-group').insertAdjacentHTML('afterbegin', '<label for="description" class="item-title">Description:</label><br /><input id="description" type="text" /><br /><br />');
            }

            //configure due date picker
            var days = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
            var today = new Date();
            var todayDayName = today.getDay();
            var relativeDays = []; //the days array translated so that today is the first element
            for (var i = todayDayName; i <= todayDayName + 6; i++) { //todayDayName + 6 can end the loop because Saturday (todayDayName = 6) is when the value of i will be the highest.  The loop continues to 6 more days (Sunday, Monday, Tuesday, Wednesday, Thursday, Friday) before it needs to end.  Thus, if Saturday = 6, and we add 6, we get 6+6 = 12; the last day is Friday (5), and 12-7 = 5; when we reach Friday i will be 12, and the loop will end.
                if (i > 6) { //if i is greater than 6, subtract 7 (say, if today is Friday, and i starts at 5, then Sunday will be i = 7, so 7-7 = 0, which is correct)
                    relativeDays.push(days[i - 7])
                } else {
                    relativeDays.push(days[i]);
                }
            }

            var toAdd = "";
            var dayNames = relativeDays;
            dayNames[0] = "Next " + dayNames[0];
            if (settings.debugMode) {
                console.log(dayNames);
            }
            var dayToAdd;

            for (i = 2; i <= relativeDays.length; i++) { //start at the day after tomorrow
                if (i > 6) {
                    j = i - 7;
                    dayToAdd = dayNames[j];
                } else {
                    dayToAdd = dayNames[i];
                }
                toAdd += '<input type="radio" id="due-date-plus' + i + '" name="due-date"> <label for="due-date-plus' + i + '">' + dayToAdd + '</label><br />'; //this can apply to any value of i because only the day of the week is part of the array and needs to be corrected when i >= 7.  the id's for the radio buttons use plus_, and the Next [today] value is 7 days from now, so it should have 7 subtracted from it

            }

            document.getElementById('due-date-days').insertAdjacentHTML('beforeend', toAdd);


            if (settings.debugMode) {
                console.warn("Debug mode is enabled.  Disable before committing to GitHub");
                console.log(relativeDays);
            }

            document.getElementById('loading').className = "hidden";
            document.getElementById('app').className = "";
        }

        function createCard() {
            if (!checkSettings()) {
                console.error("Card creation cannot continue because the settings check failed.");
                return false;
            }
            //This code doesn't work yet
            /*var trelloRequest = new XMLHttpRequest();
            var url = "https://trello.com/1/cards?key=" + settings.TRELLO_DEVELOPER_KEY + "&name=TestCard&desc=TestDesc&pos=bottom&due=9-7-2015&token=" + settings.TRELLO_TOKEN + "&idList=" + settings.TRELLO_LIST_ID[0] +  "&idMembers=";
            trelloRequest.addEventListener("load", success, false); //keep track of status
            trelloRequest.addEventListener("error", error, false);
            trelloRequest.open("post", url);*/

        }

        function checkSettings() {
            var problems = [];
            if (settings.TRELLO_DEVELOPER_KEY === "ENTER_TRELLO_DEVELOPER_KEY_HERE") {
                problems.push("The Trello developer key is set to the default value.  Change it to your developer key.  You can find it at https://trello.com/1/appKey/generate.");
            }
            if (settings.TRELLO_TOKEN === "ENTER_GENERATED_TRELLO_TOKEN_HERE") {
                problems.push("The Trello user token is set to the default value.  You'll need to set settings.firstRun to true to see how to solve this.");
            }
            if (settings.TRELLO_BOARD_ID === "ENTER_TRELLO_BOARD_ID_HERE") {
                problems.push("The Trello board ID is set to the default value.  The board ID is the 8-character string after b/ in the URL of the Trello board you want to send cards to.");
            }
            if (settings.TRELLO_LISTS[0] === "ENTER_LIST_IDS" || TRELLO_LISTS[0] === "LIST_ID2" || TRELLO_LISTS[1] === "ENTER_LIST_IDS" || TRELLO_LISTS[1] === "LIST_ID2") {
                problems.push("The Trello list ID array contains one or more default values.  Replace them with your list IDs.  Set settings.firstRun to true and follow the instructions to resolve this issue.");
            }
            if (settings.assignMyself && settings.TRELLO_USER_ID === "ENTER_USERID_HERE") {
                problems.push("The Trello user ID is not set but assignMyself is set to true.  To resolve, either set settings.assignMyself to false or set settings.firstRun to true and follow the instructions.");
            }
            if (problems) {
                plural = "s";
                if (problems.length === 1) {
                    plural = "";
                }
                console.error("Settings check failed.");
                for (i = 0; i < problems.length; i++) {
                    console.error(problems[i]);
                }
                alert(problems.length + " error" + plural + " occurred.  See the console for more information.  You must solve the errors to create cards.");
            }
        }

        function success(evt) {
            alert("It worked!");
        }

        function error(evt) {
            alert("Something went wrong.  See console.");
            if (settings.debugMode) {
                console.error("The request failed.");
                console.error(evt);
            }

        }

    </script>
</body>

</html>
